<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <title>Судоку</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* --- Система тем на CSS-переменных (без изменений) --- */
    :root, body[data-theme="purple"] { --primary-color: #a855f7; --primary-hover: #9333ea; --text-accent: #c084fc; --body-bg: #030712; --container-bg: #111827; --cell-bg: #1f2937; --grid-line: #4b5563; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(168, 85, 247, 0.06); --active-cell-bg: rgba(168, 85, 247, 0.12); --hint-bg: #ffffff; --hint-text: #111827; }
    body[data-theme="orange"] { --primary-color: #f97316; --primary-hover: #ea580c; --text-accent: #fb923c; --body-bg: #0c0a09; --container-bg: #1c1917; --cell-bg: #292524; --grid-line: #57534e; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(249, 115, 22, 0.06); --active-cell-bg: rgba(249, 115, 22, 0.12); --hint-bg: #ffffff; --hint-text: #1c1917; }
    body[data-theme="green"] { --primary-color: #22c55e; --primary-hover: #16a34a; --text-accent: #4ade80; --body-bg: #050f09; --container-bg: #0f1a14; --cell-bg: #1a2e24; --grid-line: #3f6251; --given-text: #ffffff; --error-text: #f87171; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(34, 197, 94, 0.06); --active-cell-bg: rgba(34, 197, 94, 0.12); --hint-bg: #ffffff; --hint-text: #0f1a14; }
    body[data-theme="light"] { --primary-color: #2563eb; --primary-hover: #1d4ed8; --text-accent: #1d4ed8; --body-bg: #f3f4f6; --container-bg: #ffffff; --cell-bg: #f9fafb; --grid-line: #d1d5db; --given-text: #111827; --error-text: #dc2626; --highlight-bg: #93c5fd; --highlight-text: #111827; --area-highlight-bg: rgba(59, 130, 246, 0.08); --active-cell-bg: rgba(59, 130, 246, 0.16); --hint-bg: #111827; --hint-text: #ffffff; }
    body[data-theme="black"] { --primary-color: #e5e7eb; --primary-hover: #ffffff; --text-accent: #e5e7eb; --body-bg: #000000; --container-bg: #111111; --cell-bg: #1f1f1f; --grid-line: #333333; --given-text: #ffffff; --error-text: #ef4444; --highlight-bg: #e5e7eb; --highlight-text: #000000; --area-highlight-bg: rgba(229, 231, 235, 0.05); --active-cell-bg: rgba(229, 231, 235, 0.1); --hint-bg: #ffffff; --hint-text: #111111; }
    body[data-theme="pink"] { --primary-color: #ec4899; --primary-hover: #db2777; --text-accent: #f472b6; --body-bg: #1a0810; --container-bg: #2a0f1c; --cell-bg: #3a1628; --grid-line: #6d284f; --given-text: #ffffff; --error-text: #fca5a5; --highlight-bg: var(--primary-color); --highlight-text: var(--given-text); --area-highlight-bg: rgba(236, 72, 153, 0.06); --active-cell-bg: rgba(236, 72, 153, 0.12); --hint-bg: #ffffff; --hint-text: #2a0f1c; }
    body[data-theme="turquoise"] { --primary-color: #14b8a6; --primary-hover: #0d9488; --text-accent: #2dd4bf; --body-bg: #040f0d; --container-bg: #0a1a17; --cell-bg: #112e29; --grid-line: #1f6259; --given-text: #ffffff; --error-text: #fca5a5; --highlight-bg: var(--primary-color); --highlight-text: #040f0d; --area-highlight-bg: rgba(20, 184, 166, 0.06); --active-cell-bg: rgba(20, 184, 166, 0.12); --hint-bg: #ffffff; --hint-text: #0a1a17; }
    body[data-theme="purple"] .user-input .cell-content, body[data-theme="orange"] .user-input .cell-content, body[data-theme="green"] .user-input .cell-content, body[data-theme="pink"] .user-input .cell-content, body[data-theme="turquoise"] .user-input .cell-content { color: var(--primary-color); }
    body[data-theme="black"] .user-input .cell-content { color: #9ca3af; }
    body[data-theme="light"] .user-input .cell-content { color: var(--primary-color); }

    /* --- Общие стили (без изменений) --- */
    body { background-color: var(--body-bg); color: var(--text-accent); transition: background-color 0.3s; }
    #game-container { transition: transform 0.2s ease-in-out; background-color: var(--container-bg); width: 100%; max-width: 420px; margin: auto; }
    @media (min-width: 768px) { #game-container { max-width: 600px; } }
    @media (min-width: 1024px) { #game-container { max-width: 640px; } }
    .glow { box-shadow: 0 0 10px color-mix(in srgb, var(--primary-color) 50%, transparent); }
    .title-text { color: var(--primary-color); }
    .control-button, .select-box { background-color: var(--cell-bg); color: var(--text-accent); }
    .main-button { background-color: var(--primary-color); color: white; }
    .main-button:hover { background-color: var(--primary-hover); }
    body[data-theme="black"] .main-button { color: #111111; }
    .grid-container { display: grid; grid-template-columns: repeat(9, minmax(0, 1fr)); gap: 2px; position: relative; width: 100%; padding: 3px; border-radius: 12px; background-color: var(--grid-line); }
    .cell { transition: background-color 0.2s ease-in-out; width: 100%; height: 0; padding-bottom: 100%; position: relative; border: none; border-radius: 6px; font-size: clamp(1rem, 4.5vw, 1.75rem); caret-color: transparent; background-color: var(--cell-bg); }
    .cell-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .error .cell-content { color: var(--error-text) !important; font-weight: 700; }
    .given .cell-content { color: var(--given-text); font-weight: 700; }
    .user-input .cell-content { font-weight: 500; }
    .grid-separator { position: absolute; z-index: 1; background-color: var(--primary-color); }
    .v-sep-1 { left: 33.333%; right: 33.333%; top: 3px; bottom: 3px; width: 2px; transform: translateX(-1px); }
    .v-sep-2 { left: 66.666%; right: 0; top: 3px; bottom: 3px; width: 2px; transform: translateX(-1px); }
    .h-sep-1 { top: 33.333%; bottom: 33.333%; left: 3px; right: 3px; height: 2px; transform: translateY(-1px); }
    .h-sep-2 { top: 66.666%; bottom: 0; left: 3px; right: 3px; height: 2px; transform: translateY(-1px); }
    .number-button { width: 100%; height: 0; padding-bottom: 100%; position: relative; }
    .number-button-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: clamp(1rem, 4vw, 1.5rem); border-radius: 0.375rem; background-color: var(--cell-bg); color: var(--text-accent); transition: background-color 0.2s; }
    .number-button-wrapper.selected .number-button-content { background-color: var(--primary-color); color: var(--given-text); }
    .number-button-wrapper.disabled .number-button-content { opacity: 0.4; cursor: not-allowed; }
    .area-highlight { background-color: var(--area-highlight-bg); }
    .active-cell { background-color: var(--active-cell-bg) !important; }
    .highlight { background-color: var(--highlight-bg) !important; z-index: 5; }
    .highlight .cell-content { color: var(--highlight-text) !important; font-weight: 700; }
    .hinted { background-color: var(--hint-bg) !important; z-index: 10; }
    .hinted .cell-content { color: var(--hint-text) !important; font-weight: 700; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background-color: var(--container-bg); padding: 1.5rem; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-preview-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; width: 80px; height: 80px; background-color: var(--grid-line); flex-shrink: 0; }
    .modal-preview-cell { background-color: var(--cell-bg); font-size: 0.5rem; display: flex; align-items: center; justify-content: center; }
    .tutorial-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; background-color: var(--grid-line); border: 2px solid var(--primary-color); }
    .tutorial-cell { background-color: var(--cell-bg); color: var(--given-text); font-size: 0.8rem; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s; padding-bottom: 100%; }
    .tut-highlight { background-color: var(--area-highlight-bg); }
    .tut-conflict { color: var(--error-text); }
    .tut-target { background-color: var(--active-cell-bg); }
    @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .tut-placed { animation: pop 0.3s ease-out; color: var(--primary-color); font-weight: 700; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">
  
  <div id="game-container" class="rounded-2xl p-4 glow">
    <!-- HTML структура игры (без изменений) -->
    <div id="user-info" class="flex items-center mb-4">
      <img id="user-avatar" src="https://t.me/i/userpic/320/default.jpg" alt="User Avatar" class="w-10 h-10 rounded-full mr-3">
      <div>
        <h2 id="username" class="font-bold text-lg">Username</h2>
        <p class="text-sm">Очки: <span id="user-score">0</span></p>
      </div>
    </div>
    <h1 class="title-text text-2xl font-bold text-center mb-4">Судоку</h1>
    <div class="mb-4 flex justify-between items-center">
      <select id="difficulty" class="select-box rounded-lg p-2 glow text-sm">
        <option value="easy">Лёгкий</option>
        <option value="medium">Средний</option>
        <option value="hard">Сложный</option>
      </select>
      <div class="flex items-center gap-2 sm:gap-4 relative">
        <button id="rating-button" class="control-button p-2 rounded-lg glow transition-colors" title="Рейтинг"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg></button>
        <button id="tutorial-button" class="control-button p-2 rounded-lg glow transition-colors" title="Как играть?"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg></button>
        <button id="recent-games-button" class="control-button p-2 rounded-lg glow transition-colors" title="Недавние игры"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg></button>
        <button id="settings-button" class="control-button p-2 rounded-lg glow transition-colors" title="Настройки темы"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.11.55-.102 1.13-.102 1.68 0 .55.103 1.02.568 1.11 1.11.09.542.09 1.128 0 1.67-.09.542-.56 1.007-1.11 1.11-.55-.102-1.13-.102-1.68 0-.55-.103-1.02-.568-1.11-1.11-.09-.542-.09-1.128 0-1.67zM14.25 10.25a2.25 2.25 0 00-2.25-2.25H7.5a2.25 2.25 0 00-2.25 2.25v.5c0 .59.38 1.095.92 1.254a2.25 2.25 0 011.68.026l.22.067.22.067.22.067a2.25 2.25 0 011.13 1.933V16.5a2.25 2.25 0 002.25 2.25h.5a2.25 2.25 0 002.25-2.25v-2.25a2.25 2.25 0 00-1.13-1.933l-.22-.067-.22-.067-.22-.067a2.25 2.25 0 01-1.68-.026 1.125 1.125 0 01-.92-1.254v-.5z" /></svg></button>
        <div id="theme-panel" class="hidden absolute top-full right-0 mt-2 p-2 bg-gray-800 rounded-lg shadow-lg z-20"><div class="flex gap-2 flex-wrap max-w-xs justify-end"><button class="theme-button w-6 h-6 rounded-full bg-purple-500 border-2" data-theme="purple"></button><button class="theme-button w-6 h-6 rounded-full bg-orange-500 border-2" data-theme="orange"></button><button class="theme-button w-6 h-6 rounded-full bg-green-500 border-2" data-theme="green"></button><button class="theme-button w-6 h-6 rounded-full bg-black border-2 border-gray-600" data-theme="black"></button><button class="theme-button w-6 h-6 rounded-full bg-pink-500 border-2" data-theme="pink"></button><button class="theme-button w-6 h-6 rounded-full bg-teal-500 border-2" data-theme="turquoise"></button><button class="theme-button w-6 h-6 rounded-full bg-white border-2 border-gray-400" data-theme="light"></button></div></div>
        <div id="timer" class="timer-text font-semibold text-sm">00:00</div>
      </div>
    </div>
    <div id="grid" class="grid-container mx-auto"></div>
    <div id="number-row" class="grid grid-cols-10 gap-1 sm:gap-2 mt-4 mx-auto"></div>
    <div class="mt-4 flex flex-wrap justify-center gap-2">
      <button id="undo-button" class="main-button text-white px-3 py-2 rounded-lg glow text-sm disabled:opacity-50" disabled title="Отменить"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mx-auto"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg></button>
      <button id="hint-button" class="main-button text-white px-3 py-2 rounded-lg glow text-sm disabled:opacity-50" title="Подсказка"><svg fill="currentColor" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mx-auto"><path d="M2.016 16q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM5.504 24.512q0 0.8 0.576 1.408t1.44 0.576 1.408-0.576 0.576-1.408-0.576-1.408-1.408-0.608-1.44 0.608-0.576 1.408zM5.504 7.52q0 0.832 0.576 1.408t1.44 0.576 1.408-0.576 0.576-1.408-0.576-1.408-1.408-0.608-1.44 0.608-0.576 1.408zM8 16q0 3.328 2.336 5.664t5.664 2.336 5.664-2.336 2.336-5.664-2.336-5.632-5.664-2.368-5.664 2.368-2.336 5.632zM12 16q0-1.632 1.184-2.816t2.816-1.184 2.816 1.184 1.184 2.816-1.184 2.848-2.816 1.152-2.816-1.152-1.184-2.848zM14.016 28q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM14.016 4q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408zM22.496 24.512q0 0.8 0.576 1.408t1.408 0.576 1.44-0.576 0.576-1.408-0.576-1.408-1.44-0.608-1.408 0.608-0.576 1.408zM22.496 7.52q0 0.832 0.576 1.408t1.408 0.576 1.44-0.576 0.576-1.408-0.576-1.408-1.44-0.608-1.408 0.608-0.576 1.408zM26.016 16q0 0.832 0.576 1.44t1.408 0.576 1.408-0.576 0.608-1.44-0.608-1.408-1.408-0.576-1.408 0.576-0.576 1.408z"></path></svg></button>
      <button id="newGame" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Новая игра</button>
      <button id="highlightToggle" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Подсветка</button>
      <button id="check" class="main-button text-white px-3 py-2 rounded-lg glow text-sm">Проверить</button>
    </div>
    <p id="message" class="mt-4 text-center text-sm h-5"></p>
  </div>

  <div id="recent-games-modal" class="modal-overlay hidden">
    <!-- ... HTML модальных окон без изменений ... -->
  </div>
  <div id="rating-modal" class="modal-overlay hidden">
    <!-- ... -->
  </div>
  <div id="tutorial-modal" class="modal-overlay hidden">
    <!-- ... -->
  </div>

  <!-- СКРИПТЫ FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- Добавляем скрипт для Аутентификации -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    // TODO: Вставьте сюда ваш firebaseConfig из консоли Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBkYQ7tRMrZ-mghBnkJ_EvuzHpjs_p8hOY",
      authDomain: "sudo-9fbfc.firebaseapp.com",
      projectId: "sudo-9fbfc",
      storageBucket: "sudo-9fbfc.firebasestorage.app",
      messagingSenderId: "927814106972",
      appId: "1:927814106972:web:71e0773453f9d16f598b99"
    };

    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth(); // Инициализируем сервис Аутентификации
    const usersCollection = db.collection('users');

    const elements = { body: document.body, gameContainer: document.getElementById('game-container'), grid: document.getElementById('grid'), difficulty: document.getElementById('difficulty'), newGameBtn: document.getElementById('newGame'), checkBtn: document.getElementById('check'), highlightBtn: document.getElementById('highlightToggle'), timer: document.getElementById('timer'), message: document.getElementById('message'), numberRow: document.getElementById('number-row'), undoBtn: document.getElementById('undo-button'), hintBtn: document.getElementById('hint-button'), recentGamesBtn: document.getElementById('recent-games-button'), recentGamesModal: document.getElementById('recent-games-modal'), closeModalBtn: document.getElementById('close-modal-button'), recentGamesList: document.getElementById('recent-games-list'), settingsBtn: document.getElementById('settings-button'), themePanel: document.getElementById('theme-panel'), tutorialBtn: document.getElementById('tutorial-button'), tutorialModal: document.getElementById('tutorial-modal'), closeTutorialBtn: document.getElementById('close-tutorial-button'), tutorialGrid: document.getElementById('tutorial-grid'), tutorialText: document.getElementById('tutorial-text'), tutorialTitle: document.getElementById('tutorial-title'), tutorialPrevBtn: document.getElementById('tutorial-prev'), tutorialNextBtn: document.getElementById('tutorial-next'), tutorialStepIndicator: document.getElementById('tutorial-step-indicator'), ratingBtn: document.getElementById('rating-button'), ratingModal: document.getElementById('rating-modal'), closeRatingBtn: document.getElementById('close-rating-button'), ratingList: document.getElementById('rating-list'), userAvatar: document.getElementById('user-avatar'), username: document.getElementById('username'), userScore: document.getElementById('user-score') };
    let grid = [], solution = [], givenCells = new Set(), timerInterval, startTime=0, activeCell = null, activeTool = null, highlightEnabled = true, undoStack = [];
    let hintCount = 0;
    // ID теперь будет браться из auth, а не из Telegram
    let currentUser = { id: null, username: 'Гость', avatar: 'https://t.me/i/userpic/320/default.jpg', score: 0 };
    
    // --- ВСЕ ФУНКЦИИ ЛОГИКИ ИГРЫ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ ---
    function createGrid() { /* ... */ }
    function createNumberRow() { /* ... */ }
    function generatePuzzle(difficulty) { /* ... */ }
    // ... и все остальные функции до addPoints ...
    
    // --- ИЗМЕНЕННЫЕ ФУНКЦИИ ДЛЯ РАБОТЫ С FIREBASE ---
    async function addPoints() {
        const difficulty = elements.difficulty.value;
        let basePoints = 0;
        if (difficulty === 'easy') basePoints = 100;
        else if (difficulty === 'medium') basePoints = 250;
        else if (difficulty === 'hard') basePoints = 500;
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        const timeBonus = Math.max(0, (basePoints * 2) - elapsedSeconds);
        const hintPenalty = hintCount * 50;
        const totalPoints = Math.max(10, basePoints + timeBonus - hintPenalty);
        currentUser.score += totalPoints;
        await updateUserScore(); // Вызываем обновленную функцию
        elements.message.textContent = `Поздравляем! +${totalPoints} очков!`;
    }

    async function updateUserScore() {
        elements.userScore.textContent = currentUser.score;
        // Проверяем, что пользователь вошел в систему и у него есть ID
        if (!currentUser.id) {
          console.error("Пользователь не аутентифицирован, счет не может быть сохранен.");
          return; 
        }
        
        const userDoc = {
            username: currentUser.username,
            avatar: currentUser.avatar,
            score: currentUser.score
        };

        try {
            // Используем ID от Firebase Auth для записи. Правила безопасности проверят его.
            await usersCollection.doc(currentUser.id).set(userDoc, { merge: true });
        } catch (error) {
            console.error("Ошибка при обновлении очков: ", error);
            // Если ошибка связана с правами доступа, это значит, что правила работают
            if (error.code === 'permission-denied') {
                alert("Ошибка безопасности: попытка изменить чужой счет.");
            }
        }
    }

    async function populateLeaderboard() {
        elements.ratingList.innerHTML = '<p>Загрузка рейтинга...</p>';
        try {
            const snapshot = await usersCollection.orderBy('score', 'desc').limit(100).get();
            if (snapshot.empty) {
                elements.ratingList.innerHTML = '<p>Рейтинг пуст.</p>';
                return;
            }

            const leaderboard = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            elements.ratingList.innerHTML = '';
            
            let currentUserInTop10 = false;
            leaderboard.slice(0, 10).forEach((user, index) => {
                // Сравниваем ID из Firebase Auth
                const isCurrentUser = user.id === currentUser.id;
                if(isCurrentUser) currentUserInTop10 = true;
                
                const userEl = document.createElement('div');
                userEl.className = `flex items-center gap-4 p-2 rounded-lg ${isCurrentUser ? 'bg-[var(--active-cell-bg)]' : ''}`;
                userEl.innerHTML = `
                    <span class="font-bold w-6 text-center">${index + 1}</span>
                    <img src="${user.avatar}" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <div class="flex-grow"><p class="font-bold">${user.username}</p></div>
                    <span class="font-bold">${user.score}</span>
                `;
                elements.ratingList.appendChild(userEl);
            });

            const userRankIndex = leaderboard.findIndex(user => user.id === currentUser.id);
            if (!currentUserInTop10 && userRankIndex !== -1) {
                const user = leaderboard[userRankIndex];
                elements.ratingList.innerHTML += '<div class="text-center my-2">...</div>';
                const userEl = document.createElement('div');
                userEl.className = 'flex items-center gap-4 p-2 rounded-lg bg-[var(--active-cell-bg)]';
                userEl.innerHTML = `
                    <span class="font-bold w-6 text-center">${userRankIndex + 1}</span>
                    <img src="${user.avatar}" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <div class="flex-grow"><p class="font-bold">${user.username}</p></div>
                    <span class="font-bold">${user.score}</span>
                `;
                elements.ratingList.appendChild(userEl);
            }
        } catch (error) {
            console.error("Ошибка при загрузке рейтинга: ", error);
            elements.ratingList.innerHTML = '<p>Не удалось загрузить рейтинг.</p>';
        }
    }

    async function init() {
        try {
          // Анонимно входим в систему при запуске игры
          const userCredential = await auth.signInAnonymously();
          currentUser.id = userCredential.user.uid; // Получаем безопасный ID
          console.log("Анонимный вход успешен, ID пользователя:", currentUser.id);

        } catch (error) {
          console.error("Ошибка анонимной аутентификации:", error);
          alert("Не удалось подключиться к сервису рейтинга. Пожалуйста, перезагрузите игру.");
        }
        
        // Получаем данные из Telegram, как и раньше
        if (window.Telegram && window.Telegram.WebApp) {
            const telegram = window.Telegram.WebApp;
            telegram.ready();
            if (telegram.initDataUnsafe && telegram.initDataUnsafe.user) {
                const user = telegram.initDataUnsafe.user;
                currentUser.username = user.username || 'Guest';
                if (user.photo_url) {
                    currentUser.avatar = user.photo_url;
                }
            }
        }
        
        elements.username.textContent = currentUser.username;
        elements.userAvatar.src = currentUser.avatar;

        // Загружаем счет пользователя из Firestore по его безопасному ID
        if (currentUser.id) {
            try {
                const doc = await usersCollection.doc(currentUser.id).get();
                if (doc.exists) {
                    currentUser.score = doc.data().score || 0;
                } else {
                    // Если пользователя нет, он будет создан при первом обновлении счета
                    // с 0 очков.
                    await updateUserScore();
                }
            } catch (error) {
                console.error("Ошибка при загрузке данных пользователя: ", error);
            }
        }
        elements.userScore.textContent = currentUser.score;

        const startNewGame = () => { saveCurrentGame(); createGrid(); createNumberRow(); generatePuzzle(elements.difficulty.value); elements.message.textContent = ""; hintCount = 0; };
        
        elements.newGameBtn.addEventListener('click', startNewGame);
        elements.checkBtn.addEventListener('click', checkSolution);
        // ... остальная часть init (добавление event listeners) без изменений ...
    }
    
    // Запускаем всю логику
    init();
  </script>
</body>
</html>
